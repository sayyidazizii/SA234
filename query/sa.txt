USE [ISAPabrik]
GO
/****** Object:  StoredProcedure [dbo].[rsp_RekapHargaBeli]    Script Date: 08/04/2022 09:06:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author	  : T I O C M 
-- Create date: 12 April 2022
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[rsp_RekapHargaBeli] 
	@fromdate date = '20220101',
	@todate date = '20220331'
AS
BEGIN
	DECLARE @fromdate_lokal date = @fromdate

	DECLARE @TblData TABLE
	(
		Company varchar(5),
		VendorID varchar(50), 
		VendorName varchar(150), 
		PartNum varchar(50), 
		PartDesc varchar(1500), 
		Tanggal date, 
		Harga money
	)
	
	DECLARE @TblDataFix TABLE
	(
		Company varchar(5),
		VendorID varchar(50), 
		VendorName varchar(150), 
		PartNum varchar(50), 
		PartDesc varchar(1500), 
		Tanggal date, 
		Harga money
	)

	INSERT INTO @TblData
	SELECT * FROM
	(
		SELECT 'SASS' Company, VendorID, VendorName, PartNum, PartDesc
		, Periode + '01' Tanggal, MAX(Harga) Harga 
		FROM HargaBeliEPC 
		GROUP BY VendorID, VendorName, PartNum, PartDesc, Periode
	UNION ALL
		SELECT 
			'NKYM' Company, s.Kode, s.Supplier, m.KdMaterial, m.NmMaterial
			, CONVERT(VARCHAR(6),TglPengakuan, 112) + '01' Periode, MAX(snbd.HargaNota)
		FROM SJNotaPembelianDetail snbd (NOLOCK) 
		LEFT JOIN NotaPembelian nb (NOLOCK) on nb.RowID=snbd.IDNotaPembelian
		LEFT JOIN SJPembelian sj (NOLOCK) on sj.RowID=snbd.IDSJPembelian
		LEFT JOIN Material m (NOLOCK) on m.RowID=snbd.IDMaterial
		LEFT JOIN Supplier s (NOLOCK) on s.RowID=nb.IDSupplier
		WHERE nb.TglNota BETWEEN @fromdate AND @todate 
		GROUP BY s.Kode, s.Supplier, m.KdMaterial, m.NmMaterial, CONVERT(VARCHAR(6),TglPengakuan, 112)
	UNION ALL
		SELECT 
			'SASS' Company, s.Kode, s.Supplier, m.KdMaterial, m.NmMaterial
			, CONVERT(VARCHAR(6),TglPengakuan, 112) + '01' Periode, MAX(snbd.HargaNota)
		FROM [131.68.5.221,1433].ISAPabrik.dbo.SJNotaPembelianDetail snbd (NOLOCK) 
		LEFT JOIN [131.68.5.221,1433].ISAPabrik.dbo.NotaPembelian nb (NOLOCK) on nb.RowID=snbd.IDNotaPembelian
		LEFT JOIN [131.68.5.221,1433].ISAPabrik.dbo.SJPembelian sj (NOLOCK) on sj.RowID=snbd.IDSJPembelian
		LEFT JOIN [131.68.5.221,1433].ISAPabrik.dbo.Material m (NOLOCK) on m.RowID=snbd.IDMaterial
		LEFT JOIN [131.68.5.221,1433].ISAPabrik.dbo.Supplier s (NOLOCK) on s.RowID=nb.IDSupplier
	
		WHERE nb.TglNota BETWEEN @fromdate AND @todate 
		AND TglNota <= '2020-12-31'
		GROUP BY s.Kode, s.Supplier, m.KdMaterial, m.NmMaterial, CONVERT(VARCHAR(6),TglPengakuan, 112) 
	)X
	
	INSERT INTO @TblDataFix
	SELECT *
	FROM @TblData
	WHERE Tanggal BETWEEN @fromdate_lokal AND @todate

	SELECT Distinct Company, VendorID, VendorName, PartNum, PartDesc
	into #Temp 
	FROM @TblDataFix
	ORDER BY VendorID, VendorName, PartNum, PartDesc
	
-- Tambah kolom Per Plant
	WHILE @fromdate < @todate
	BEGIN
		declare @Period varchar(6) = CONVERT(VARCHAR(6), @fromdate, 112)

		declare @query nvarchar(max)= '
		ALTER table #Temp
		ADD ['+convert(varchar(50),@Period)+'] money'

		exec sp_executesql @query
		
		SET @fromdate = DATEADD(M, 1, @fromdate)

	END

-- Isi kolom Per Periode
	DECLARE @Company varchar(5), @VendorID varchar(50), @PartNum varchar(50), @Harga money, @Periode varchar(6)
	
	DECLARE Detail CURSOR LOCAL FOR	
	SELECT DISTINCT Company, VendorID, PartNum, CONVERT(VARCHAR(6), Tanggal, 112), Harga 
	FROM @TblDataFix

	OPEN Detail

	FETCH NEXT FROM Detail
	INTO @Company, @VendorID, @PartNum, @Periode, @Harga

	WHILE @@FETCH_STATUS = 0
	BEGIN

		declare @qu nvarchar(MAX) = N'
		update #Temp set 
			['+convert(varchar(50), @Periode)+'] = '+convert(varchar(25), @Harga )+'
		where VendorID = '''+convert(varchar(max),@VendorID)+''' 
			AND PartNum = '''+convert(varchar(max),@PartNum)+'''
			AND Company = '''+convert(varchar(max),@Company)+'''
			'
		
		exec sp_executesql @qu

	FETCH NEXT FROM Detail
	INTO @Company, @VendorID, @PartNum, @Periode, @Harga
	END

	CLOSE Detail
	DEALLOCATE Detail

-- Tampilan 
	SELECT a.*, x.HargaMin, x.HargaMax , x.HargaAvg FROM #Temp a
	outer apply
	(
		SELECT MAX(Z.Harga) HargaMax, MIN(z.Harga) HargaMin, AVG(z.Harga) HargaAvg FROM @TblDataFix Z
		WHERE Z.Company = a.Company
		AND Z.VendorID = a.VendorID
		AND Z.PartNum = a.PartNum
		GROUP BY z.VendorID, z.PartNum
	) X
	WHERE Company = 'SASS'
	
	SELECT a.*, x.HargaMin, x.HargaMax FROM #Temp a
	outer apply
	(
		SELECT z.VendorID, z.PartNum, MAX(Z.Harga) HargaMax, MIN(z.Harga) HargaMin FROM @TblDataFix Z
		WHERE Z.Company = a.Company
		AND Z.VendorID = a.VendorID
		AND Z.PartNum = a.PartNum
		GROUP BY z.VendorID, z.PartNum
	) X
	WHERE Company = 'NKYM'
	
	DROP TABLE #Temp
	
END